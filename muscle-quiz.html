<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>ç­‹è‚‰ Ã— ç¥çµŒæ”¯é… Ã— èµ·å§‹ãƒ»åœæ­¢ï½œã‚¯ã‚¤ã‚ºã‚¢ãƒ—ãƒª</title>
<style>
  :root{--bg:#0f1115;--card:#171a21;--ink:#e7ebf3;--muted:#9aa4b2;--accent:#4da3ff;--accent2:#7bf;--danger:#ff6b6b;--ok:#22c55e;}
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Hiragino Kaku Gothic ProN", "Yu Gothic", "Noto Sans JP", sans-serif;
    color:var(--ink); background:linear-gradient(180deg,#0d0f14,#0f1115 30%, #11151c);
  }
  header{
    position:sticky; top:0; z-index:10; backdrop-filter:saturate(150%) blur(8px);
    background:rgba(15,17,21,0.75); border-bottom:1px solid #1f2430;
    padding:10px 12px;
  }
  .title{display:flex; align-items:center; gap:10px; font-weight:700;}
  .title .badge{font-size:12px; color:#0b1320; background:linear-gradient(135deg,var(--accent),#80bfff);
    padding:3px 8px; border-radius:999px;}
  .row{display:flex; gap:10px; flex-wrap:wrap; align-items:center}
  select,button,input[type="text"]{
    background:var(--card); color:var(--ink); border:1px solid #2a2f3a;
    border-radius:10px; padding:10px 12px; font-size:14px; outline:none;
  }
  select:focus,button:focus,input:focus{border-color:var(--accent)}
  button{cursor:pointer}
  .ghost{background:transparent;border-color:#2a2f3a;color:var(--muted)}
  .accent{background:linear-gradient(135deg,var(--accent),var(--accent2)); color:#0b1320; border:none; font-weight:700}
  .danger{background:#2a1212; border-color:#592626; color:#ffb3b3}
  main{padding:16px; max-width:900px; margin:0 auto}
  .card{
    background:rgba(23,26,33,0.9); border:1px solid #1f2430; border-radius:16px; padding:16px;
    box-shadow: 0 10px 30px rgba(0,0,0,0.3);
  }
  .grid{display:grid; grid-template-columns:1fr; gap:12px}
  @media(min-width:650px){ .grid{grid-template-columns: 2fr 1fr} }
  .qtext{font-size:18px; line-height:1.5}
  .qmeta{color:var(--muted); font-size:12px}
  .choices{display:grid; gap:10px; margin-top:10px}
  .choice{padding:12px; border-radius:12px; border:1px solid #2a2f3a; background:#141821; text-align:left}
  .choice.correct{border-color:rgba(34,197,94,0.6); box-shadow:0 0 0 2px rgba(34,197,94,0.2) inset}
  .choice.wrong{border-color:rgba(255,107,107,0.6); box-shadow:0 0 0 2px rgba(255,107,107,0.15) inset}
  .pill{display:inline-block; padding:3px 8px; border-radius:999px; background:#141821; border:1px solid #2a2f3a; color:var(--muted); font-size:12px}
  .stack{display:flex; gap:6px; flex-wrap:wrap}
  .mini{font-size:12px; padding:6px 8px}
  .kbd{font-family: ui-monospace, SFMono-Regular, Menlo, Consolas; font-size:12px; background:#11151c; border:1px solid #2a2f3a; padding:2px 6px; border-radius:6px}
  .ok{color:var(--ok)} .bad{color:var(--danger)}
  .hidden{display:none!important}
  details{border:1px dashed #2a2f3a; border-radius:12px; padding:8px 10px}
  summary{cursor:pointer; color:var(--muted)}
  .footer{color:#8a93a3; font-size:12px; text-align:center; margin:18px 0}
  .tag{background:#122233; border:1px solid #1e3755; color:#9ec8ff}
  .fav{border-color:#6654ff; background:rgba(102,84,255,0.1)}
</style>
</head>
<body>
<header>
  <div class="title">
    <div>ğŸ’ª ç­‹è‚‰ã‚¯ã‚¤ã‚º</div>
    <div class="badge">åå‰ãƒ»ç¥çµŒæ”¯é…ãƒ»èµ·å§‹/åœæ­¢</div>
  </div>
  <div class="row" style="margin-top:8px">
    <select id="region">
      <option value="all">å‡ºé¡Œç¯„å›²ï¼šã™ã¹ã¦</option>
      <option>ä¸Šè‚¢</option>
      <option>å‰è…•ãƒ»æ‰‹</option>
      <option>ä¸‹è‚¢</option>
      <option>ä½“å¹¹</option>
      <option>é ¸éƒ¨</option>
    </select>
    <select id="mode">
      <option value="mc">å‡ºé¡Œå½¢å¼ï¼š4æŠ</option>
      <option value="type">å‡ºé¡Œå½¢å¼ï¼šå…¥åŠ›</option>
      <option value="card">å‡ºé¡Œå½¢å¼ï¼šãƒ•ãƒ©ãƒƒã‚·ãƒ¥ã‚«ãƒ¼ãƒ‰</option>
    </select>
    <select id="ask">
      <option value="mixed">è³ªå•ã‚¿ã‚¤ãƒ—ï¼šMIX</option>
      <option value="name_to_nerve">ç­‹ â†’ ç¥çµŒ</option>
      <option value="name_to_oi">ç­‹ â†’ èµ·å§‹/åœæ­¢</option>
      <option value="nerve_to_name">ç¥çµŒ â†’ ç­‹</option>
      <option value="oi_to_name">èµ·å§‹/åœæ­¢ â†’ ç­‹</option>
    </select>
    <button class="ghost mini" id="shuffle">ã‚·ãƒ£ãƒƒãƒ•ãƒ«</button>
    <button class="ghost mini" id="onlyMiss">é–“é•ã„ã®ã¿</button>
    <button class="ghost mini" id="toggleFav">â˜… ãŠæ°—ã«å…¥ã‚Š</button>
  </div>
</header>

<main>
  <div class="grid">
    <section class="card" id="quiz">
      <div class="qmeta" id="qmeta">#1 / 0</div>
      <div class="qtext" id="qtext">èª­ã¿è¾¼ã¿ä¸­â€¦</div>

      <div class="choices" id="choices"></div>

      <div id="typeWrap" class="hidden">
        <input id="typeInput" type="text" placeholder="ã“ã“ã«å…¥åŠ›ï¼ˆä¾‹ï¼šè…‹çª©ç¥çµŒï¼‰">
        <div class="row" style="margin-top:8px">
          <button class="accent" id="typeCheck">ç­”ãˆåˆã‚ã›</button>
          <button class="ghost" id="typeShow">ç­”ãˆã‚’è¦‹ã‚‹</button>
        </div>
      </div>

      <details id="reveal" class="hidden" style="margin-top:12px">
        <summary>è§£èª¬ / å…¨æƒ…å ±ã‚’è¡¨ç¤º</summary>
        <div id="explain" style="margin-top:8px"></div>
      </details>

      <div class="row" style="margin-top:10px">
        <button id="prev" class="ghost mini">â† å‰ã¸</button>
        <button id="again" class="ghost mini">ã‚‚ã†ä¸€åº¦</button>
        <button id="next" class="accent mini">æ¬¡ã¸ â†’</button>
      </div>
    </section>

    <aside class="card">
      <div style="display:flex; justify-content:space-between; align-items:center; gap:8px">
        <div>é€²æ—</div>
        <button id="reset" class="danger mini">æˆç¸¾ãƒªã‚»ãƒƒãƒˆ</button>
      </div>
      <div style="margin-top:8px" class="stack">
        <span class="pill">æ­£è§£ <span id="statRight">0</span></span>
        <span class="pill">ä¸æ­£è§£ <span id="statWrong">0</span></span>
        <span class="pill">é€£ç¶šæ­£è§£ <span id="streak">0</span></span>
        <span class="pill">â˜… <span id="favCount">0</span></span>
      </div>
      <div style="margin-top:12px">
        <details>
          <summary>å‡ºé¡Œãƒªã‚¹ãƒˆã‚’ä½œæˆ/ç·¨é›†ï¼ˆJSONï¼‰</summary>
          <textarea id="jsonArea" style="width:100%; height:180px; margin-top:8px; background:#0f1219; color:#dbe7ff; border:1px solid #2a2f3a; border-radius:12px; padding:10px"></textarea>
          <div class="row" style="margin-top:8px">
            <button id="applyJson" class="ghost">åæ˜ ã™ã‚‹</button>
            <button id="downloadJson" class="ghost">JSONã‚’ä¿å­˜</button>
          </div>
        </details>
      </div>
      <div style="margin-top:12px">
        <details>
          <summary>ä½¿ã„æ–¹</summary>
          <ul style="margin-top:8px; line-height:1.6">
            <li>å‡ºé¡Œå½¢å¼ï¼ˆ4æŠ / å…¥åŠ› / ãƒ•ãƒ©ãƒƒã‚·ãƒ¥ã‚«ãƒ¼ãƒ‰ï¼‰ã¨è³ªå•ã‚¿ã‚¤ãƒ—ã‚’é¸ã³ã¾ã™ã€‚</li>
            <li>ã€Œé–“é•ã„ã®ã¿ã€ã§å¼±ç‚¹ã ã‘ã‚’åå¾©ã§ãã¾ã™ï¼ˆç°¡æ˜“SRSï¼‰ã€‚</li>
            <li>â˜…ã§ãŠæ°—ã«å…¥ã‚Šç™»éŒ²ã€‚å‡ºé¡Œã¯ã€ŒãŠæ°—ã«å…¥ã‚Šã®ã¿ã€ã«åˆ‡æ›¿å¯èƒ½ï¼ˆä¸Šéƒ¨ãƒœã‚¿ãƒ³é•·æŠ¼ã—ï¼‰ã€‚</li>
            <li>å³å´ã®ã€Œç·¨é›†ã€ã§ãƒªã‚¹ãƒˆã‚’è¿½åŠ ãƒ»ä¿®æ­£ã§ãã¾ã™ï¼ˆJSONï¼‰ã€‚</li>
          </ul>
          <p class="qmeta">iPhone/ã‚ªãƒ•ãƒ©ã‚¤ãƒ³å¯¾å¿œã€‚ãƒ‡ãƒ¼ã‚¿ãƒ»æˆç¸¾ã¯ç«¯æœ«å†…ï¼ˆlocalStorageï¼‰ã«ä¿å­˜ã•ã‚Œã¾ã™ã€‚</p>
        </details>
      </div>
    </aside>
  </div>

  <div class="footer">Â© ã‚ãªãŸå°‚ç”¨ï½œå­¦ç¿’ãŒé€²ã‚€ã»ã©è³¢ãå‡ºé¡Œã—ã¾ã™</div>
</main>

<script>
// ====== å­¦ç¿’ãƒ‡ãƒ¼ã‚¿ ======
const DEFAULT_ITEMS = [
  // â€”â€” ä¸Šè‚¢ï¼ˆè‚©ç”²å¸¯ãƒ»ä¸Šè…•ï¼‰ â€”â€”
  {name_ja:"åƒ§å¸½ç­‹", name_lat:"Trapezius", region:"ä½“å¹¹", nerve:"å‰¯ç¥çµŒï¼ˆXIï¼‰ï¼‹é ¸ç¥çµŒå¢C3â€“C4", origin:"å¤–å¾Œé ­éš†èµ·ãƒ»ä¸Šé …ç·šãƒ»é …é­å¸¯ãƒ»C7â€“T12æ£˜çªèµ·", insertion:"é–éª¨å¤–å´1/3ãƒ»è‚©å³°ãƒ»è‚©ç”²æ£˜"},
  {name_ja:"åºƒèƒŒç­‹", name_lat:"Latissimus dorsi", region:"ä½“å¹¹", nerve:"èƒ¸èƒŒç¥çµŒï¼ˆC6â€“C8ï¼‰", origin:"T7â€“L5æ£˜çªèµ·ãƒ»èƒ¸è…°ç­‹è†œãƒ»è…¸éª¨ç¨œãƒ»ä¸‹ä½è‚‹éª¨", insertion:"ä¸Šè…•éª¨å°çµç¯€ç¨œï¼ˆçµç¯€é–“æºï¼‰"},
  {name_ja:"ä¸‰è§’ç­‹", name_lat:"Deltoid", region:"ä¸Šè‚¢", nerve:"è…‹çª©ç¥çµŒï¼ˆC5â€“C6ï¼‰", origin:"é–éª¨å¤–å´1/3ãƒ»è‚©å³°ãƒ»è‚©ç”²æ£˜", insertion:"ä¸Šè…•éª¨ä¸‰è§’ç­‹ç²—é¢"},
  {name_ja:"æ£˜ä¸Šç­‹", name_lat:"Supraspinatus", region:"ä¸Šè‚¢", nerve:"è‚©ç”²ä¸Šç¥çµŒï¼ˆC5â€“C6ï¼‰", origin:"è‚©ç”²éª¨æ£˜ä¸Šçª©", insertion:"ä¸Šè…•éª¨å¤§çµç¯€ä¸Šé¢"},
  {name_ja:"æ£˜ä¸‹ç­‹", name_lat:"Infraspinatus", region:"ä¸Šè‚¢", nerve:"è‚©ç”²ä¸Šç¥çµŒï¼ˆC5â€“C6ï¼‰", origin:"è‚©ç”²éª¨æ£˜ä¸‹çª©", insertion:"ä¸Šè…•éª¨å¤§çµç¯€ä¸­é¢"},
  {name_ja:"å°å††ç­‹", name_lat:"Teres minor", region:"ä¸Šè‚¢", nerve:"è…‹çª©ç¥çµŒï¼ˆC5â€“C6ï¼‰", origin:"è‚©ç”²éª¨å¤–å´ç¸", insertion:"ä¸Šè…•éª¨å¤§çµç¯€ä¸‹é¢"},
  {name_ja:"å¤§å††ç­‹", name_lat:"Teres major", region:"ä¸Šè‚¢", nerve:"è‚©ç”²ä¸‹ç¥çµŒï¼ˆä¸‹ï¼‰ï¼ˆC5â€“C6ï¼‰", origin:"è‚©ç”²éª¨ä¸‹è§’å¾Œé¢", insertion:"ä¸Šè…•éª¨å°çµç¯€ç¨œ"},
  {name_ja:"è‚©ç”²ä¸‹ç­‹", name_lat:"Subscapularis", region:"ä¸Šè‚¢", nerve:"è‚©ç”²ä¸‹ç¥çµŒï¼ˆä¸Šãƒ»ä¸‹ï¼‰ï¼ˆC5â€“C6ï¼‰", origin:"è‚©ç”²éª¨å‰é¢ï¼ˆè‚©ç”²ä¸‹çª©ï¼‰", insertion:"ä¸Šè…•éª¨å°çµç¯€"},
  {name_ja:"å¤§èƒ¸ç­‹", name_lat:"Pectoralis major", region:"ä½“å¹¹", nerve:"å¤–å´ãƒ»å†…å´èƒ¸ç­‹ç¥çµŒï¼ˆC5â€“T1ï¼‰", origin:"é–éª¨å†…å´åŠãƒ»èƒ¸éª¨ãƒ»ç¬¬1â€“6è‚‹è»Ÿéª¨ãƒ»è…¹ç›´ç­‹é˜", insertion:"ä¸Šè…•éª¨å¤§çµç¯€ç¨œï¼ˆçµç¯€é–“æºå¤–å´å”‡ï¼‰"},
  {name_ja:"å°èƒ¸ç­‹", name_lat:"Pectoralis minor", region:"ä½“å¹¹", nerve:"å†…å´èƒ¸ç­‹ç¥çµŒï¼ˆC8â€“T1ï¼‰", origin:"ç¬¬3â€“5è‚‹éª¨å‰ç«¯", insertion:"è‚©ç”²éª¨çƒå£çªèµ·"},
  {name_ja:"å‰é‹¸ç­‹", name_lat:"Serratus anterior", region:"ä½“å¹¹", nerve:"é•·èƒ¸ç¥çµŒï¼ˆC5â€“C7ï¼‰", origin:"ç¬¬1â€“8è‚‹éª¨å¤–å´é¢", insertion:"è‚©ç”²éª¨å†…å´ç¸ï¼ˆå‰é¢ï¼‰"},
  {name_ja:"è±å½¢ç­‹", name_lat:"Rhomboids", region:"ä½“å¹¹", nerve:"èƒŒå´è‚©ç”²éª¨ç¥çµŒï¼ˆC4â€“C5ï¼‰", origin:"C7â€“T5æ£˜çªèµ·ãƒ»é …é­å¸¯", insertion:"è‚©ç”²éª¨å†…å´ç¸"},
  {name_ja:"è‚©ç”²æŒ™ç­‹", name_lat:"Levator scapulae", region:"ä½“å¹¹", nerve:"èƒŒå´è‚©ç”²éª¨ç¥çµŒï¼ˆC5ï¼‰ï¼‹é ¸ç¥çµŒå¢C3â€“C4", origin:"C1â€“C4æ¨ªçªèµ·å¾Œçµç¯€", insertion:"è‚©ç”²éª¨ä¸Šè§’ãƒ»å†…å´ç¸ä¸Šéƒ¨"},
  {name_ja:"ä¸Šè…•äºŒé ­ç­‹", name_lat:"Biceps brachii", region:"ä¸Šè‚¢", nerve:"ç­‹çš®ç¥çµŒï¼ˆC5â€“C6ï¼‰", origin:"é•·é ­ï¼šè‚©ç”²éª¨é–¢ç¯€ä¸Šçµç¯€ï¼çŸ­é ­ï¼šçƒå£çªèµ·", insertion:"æ©ˆéª¨ç²—é¢ãƒ»å‰è…•ç­‹è†œï¼ˆè…±è†œï¼‰"},
  {name_ja:"çƒå£è…•ç­‹", name_lat:"Coracobrachialis", region:"ä¸Šè‚¢", nerve:"ç­‹çš®ç¥çµŒï¼ˆC5â€“C7ï¼‰", origin:"çƒå£çªèµ·", insertion:"ä¸Šè…•éª¨å†…å´é¢ä¸­éƒ¨"},
  {name_ja:"ä¸Šè…•ç­‹", name_lat:"Brachialis", region:"ä¸Šè‚¢", nerve:"ç­‹çš®ç¥çµŒï¼ˆC5â€“C6ï¼‰ï¼‹æ©ˆéª¨ç¥çµŒä¸€éƒ¨", origin:"ä¸Šè…•éª¨å‰é¢é ä½åŠåˆ†", insertion:"å°ºéª¨ç²—é¢ãƒ»å† çŠ¶çªèµ·"},
  {name_ja:"ä¸Šè…•ä¸‰é ­ç­‹", name_lat:"Triceps brachii", region:"ä¸Šè‚¢", nerve:"æ©ˆéª¨ç¥çµŒï¼ˆC6â€“C8ï¼‰", origin:"é•·é ­ï¼šé–¢ç¯€ä¸‹çµç¯€ï¼å¤–å´é ­ãƒ»å†…å´é ­ï¼šä¸Šè…•éª¨å¾Œé¢", insertion:"å°ºéª¨è‚˜é ­"},
  // â€”â€” å‰è…•ãƒ»æ‰‹ â€”â€”
  {name_ja:"å††å›å†…ç­‹", name_lat:"Pronator teres", region:"å‰è…•ãƒ»æ‰‹", nerve:"æ­£ä¸­ç¥çµŒï¼ˆC6â€“C7ï¼‰", origin:"ä¸Šè…•éª¨å†…å´ä¸Šé¡†ãƒ»å°ºéª¨éˆçŠ¶çªèµ·ï¼ˆå† çŠ¶çªèµ·ï¼‰", insertion:"æ©ˆéª¨å¤–å´é¢"},
  {name_ja:"é•·æŒç­‹", name_lat:"Palmaris longus", region:"å‰è…•ãƒ»æ‰‹", nerve:"æ­£ä¸­ç¥çµŒï¼ˆC7â€“C8ï¼‰", origin:"ä¸Šè…•éª¨å†…å´ä¸Šé¡†", insertion:"æ‰‹æŒè…±è†œ"},
  {name_ja:"æ©ˆå´æ‰‹æ ¹å±ˆç­‹", name_lat:"Flexor carpi radialis", region:"å‰è…•ãƒ»æ‰‹", nerve:"æ­£ä¸­ç¥çµŒï¼ˆC6â€“C7ï¼‰", origin:"ä¸Šè…•éª¨å†…å´ä¸Šé¡†", insertion:"ç¬¬2ãƒ»3ä¸­æ‰‹éª¨åº•"},
  {name_ja:"å°ºå´æ‰‹æ ¹å±ˆç­‹", name_lat:"Flexor carpi ulnaris", region:"å‰è…•ãƒ»æ‰‹", nerve:"å°ºéª¨ç¥çµŒï¼ˆC8â€“T1ï¼‰", origin:"ä¸Šè…•éª¨å†…å´ä¸Šé¡†ãƒ»å°ºéª¨å°ºå´ç¸", insertion:"è±†çŠ¶éª¨ãƒ»æœ‰é‰¤éª¨é‰¤ãƒ»ç¬¬5ä¸­æ‰‹éª¨åº•"},
  {name_ja:"æµ…æŒ‡å±ˆç­‹", name_lat:"Flexor digitorum superficialis", region:"å‰è…•ãƒ»æ‰‹", nerve:"æ­£ä¸­ç¥çµŒï¼ˆC7â€“T1ï¼‰", origin:"ä¸Šè…•éª¨å†…å´ä¸Šé¡†ãƒ»å°ºéª¨ãƒ»æ©ˆéª¨", insertion:"ç¬¬2â€“5æŒ‡ä¸­ç¯€éª¨åº•"},
  {name_ja:"æ·±æŒ‡å±ˆç­‹ï¼ˆæ©ˆå´ï¼‰", name_lat:"FDP (lateral half)", region:"å‰è…•ãƒ»æ‰‹", nerve:"å‰éª¨é–“ç¥çµŒï¼ˆæ­£ä¸­ï¼‰ï¼ˆC8â€“T1ï¼‰", origin:"å°ºéª¨å‰é¢ãƒ»éª¨é–“è†œ", insertion:"ç¬¬2ãƒ»3æŒ‡æœ«ç¯€éª¨åº•"},
  {name_ja:"æ·±æŒ‡å±ˆç­‹ï¼ˆå°ºå´ï¼‰", name_lat:"FDP (medial half)", region:"å‰è…•ãƒ»æ‰‹", nerve:"å°ºéª¨ç¥çµŒï¼ˆC8â€“T1ï¼‰", origin:"å°ºéª¨å‰é¢ãƒ»éª¨é–“è†œ", insertion:"ç¬¬4ãƒ»5æŒ‡æœ«ç¯€éª¨åº•"},
  {name_ja:"é•·æ¯æŒ‡å±ˆç­‹", name_lat:"Flexor pollicis longus", region:"å‰è…•ãƒ»æ‰‹", nerve:"å‰éª¨é–“ç¥çµŒï¼ˆæ­£ä¸­ï¼‰ï¼ˆC8â€“T1ï¼‰", origin:"æ©ˆéª¨å‰é¢ãƒ»éª¨é–“è†œ", insertion:"æ¯æŒ‡æœ«ç¯€éª¨åº•"},
  {name_ja:"å›å¤–ç­‹", name_lat:"Supinator", region:"å‰è…•ãƒ»æ‰‹", nerve:"å¾Œéª¨é–“ç¥çµŒï¼ˆæ©ˆéª¨ç¥çµŒæ·±æï¼‰ï¼ˆC6â€“C7ï¼‰", origin:"ä¸Šè…•éª¨å¤–å´ä¸Šé¡†ãƒ»å°ºéª¨å›å¤–ç­‹ç¨œ", insertion:"æ©ˆéª¨è¿‘ä½1/3å¤–å´é¢"},
  {name_ja:"é•·æ©ˆå´æ‰‹æ ¹ä¼¸ç­‹", name_lat:"ECRL", region:"å‰è…•ãƒ»æ‰‹", nerve:"æ©ˆéª¨ç¥çµŒï¼ˆC6â€“C7ï¼‰", origin:"ä¸Šè…•éª¨å¤–å´ä¸Šé¡†ä¸Šç¨œ", insertion:"ç¬¬2ä¸­æ‰‹éª¨åº•èƒŒå´"},
  {name_ja:"çŸ­æ©ˆå´æ‰‹æ ¹ä¼¸ç­‹", name_lat:"ECRB", region:"å‰è…•ãƒ»æ‰‹", nerve:"å¾Œéª¨é–“ç¥çµŒï¼ˆC7â€“C8ï¼‰", origin:"ä¸Šè…•éª¨å¤–å´ä¸Šé¡†", insertion:"ç¬¬3ä¸­æ‰‹éª¨åº•èƒŒå´"},
  {name_ja:"ç·æŒ‡ä¼¸ç­‹", name_lat:"Extensor digitorum", region:"å‰è…•ãƒ»æ‰‹", nerve:"å¾Œéª¨é–“ç¥çµŒï¼ˆC7â€“C8ï¼‰", origin:"ä¸Šè…•éª¨å¤–å´ä¸Šé¡†", insertion:"ç¬¬2â€“5æŒ‡ä¼¸ç­‹è…±è†œ"},
  {name_ja:"å°ºå´æ‰‹æ ¹ä¼¸ç­‹", name_lat:"ECU", region:"å‰è…•ãƒ»æ‰‹", nerve:"å¾Œéª¨é–“ç¥çµŒï¼ˆC7â€“C8ï¼‰", origin:"ä¸Šè…•éª¨å¤–å´ä¸Šé¡†ãƒ»å°ºéª¨", insertion:"ç¬¬5ä¸­æ‰‹éª¨åº•èƒŒå´"},
  {name_ja:"çŸ­æ¯æŒ‡ä¼¸ç­‹ï¼é•·æ¯æŒ‡ä¼¸ç­‹", name_lat:"EPB/EPL", region:"å‰è…•ãƒ»æ‰‹", nerve:"å¾Œéª¨é–“ç¥çµŒï¼ˆC7â€“C8ï¼‰", origin:"æ©ˆéª¨ãƒ»å°ºéª¨å¾Œé¢ï¼éª¨é–“è†œ", insertion:"æ¯æŒ‡åŸºç¯€éª¨åº•ï¼æœ«ç¯€éª¨åº•"},
  {name_ja:"é•·æ¯æŒ‡å¤–è»¢ç­‹", name_lat:"Abductor pollicis longus", region:"å‰è…•ãƒ»æ‰‹", nerve:"å¾Œéª¨é–“ç¥çµŒï¼ˆC7â€“C8ï¼‰", origin:"æ©ˆéª¨ãƒ»å°ºéª¨å¾Œé¢ï¼éª¨é–“è†œ", insertion:"ç¬¬1ä¸­æ‰‹éª¨åº•"},
  // â€”â€” ä¸‹è‚¢ â€”â€”
  {name_ja:"å¤§æ®¿ç­‹", name_lat:"Gluteus maximus", region:"ä¸‹è‚¢", nerve:"ä¸‹æ®¿ç¥çµŒï¼ˆL5â€“S2ï¼‰", origin:"è…¸éª¨å¾Œé¢ãƒ»ä»™éª¨ãƒ»å°¾éª¨ãƒ»ä»™çµç¯€é­å¸¯", insertion:"è…¸è„›é­å¸¯ãƒ»å¤§è…¿éª¨æ®¿ç­‹ç²—é¢"},
  {name_ja:"ä¸­æ®¿ç­‹", name_lat:"Gluteus medius", region:"ä¸‹è‚¢", nerve:"ä¸Šæ®¿ç¥çµŒï¼ˆL4â€“S1ï¼‰", origin:"è…¸éª¨å¤–å´é¢", insertion:"å¤§è…¿éª¨å¤§è»¢å­å¤–å´é¢"},
  {name_ja:"å°æ®¿ç­‹", name_lat:"Gluteus minimus", region:"ä¸‹è‚¢", nerve:"ä¸Šæ®¿ç¥çµŒï¼ˆL4â€“S1ï¼‰", origin:"è…¸éª¨å¤–å´é¢", insertion:"å¤§è…¿éª¨å¤§è»¢å­å‰é¢"},
  {name_ja:"å¤§è…¿ç­‹è†œå¼µç­‹", name_lat:"Tensor fasciae latae", region:"ä¸‹è‚¢", nerve:"ä¸Šæ®¿ç¥çµŒï¼ˆL4â€“S1ï¼‰", origin:"ä¸Šå‰è…¸éª¨æ£˜", insertion:"è…¸è„›é­å¸¯â†’è„›éª¨å¤–å´é¡†ï¼ˆGerdyçµç¯€ï¼‰"},
  {name_ja:"è…¸è…°ç­‹", name_lat:"Iliopsoas", region:"ä¸‹è‚¢", nerve:"å¤§è…°ç­‹ï¼šè…°ç¥çµŒå¢ï¼ˆL1â€“L3ï¼‰ï¼è…¸éª¨ç­‹ï¼šå¤§è…¿ç¥çµŒï¼ˆL2â€“L3ï¼‰", origin:"å¤§è…°ç­‹ï¼šT12â€“L5æ¤ä½“ãƒ»æ¨ªçªèµ·ï¼è…¸éª¨ç­‹ï¼šè…¸éª¨çª©", insertion:"å¤§è…¿éª¨å°è»¢å­"},
  {name_ja:"å¤§è…¿ç›´ç­‹", name_lat:"Rectus femoris", region:"ä¸‹è‚¢", nerve:"å¤§è…¿ç¥çµŒï¼ˆL2â€“L4ï¼‰", origin:"ä¸‹å‰è…¸éª¨æ£˜ãƒ»è‡¼è“‹ä¸Šç¸", insertion:"è†è“‹éª¨â†’è†è“‹é­å¸¯â†’è„›éª¨ç²—é¢"},
  {name_ja:"å¤–å´åºƒç­‹", name_lat:"Vastus lateralis", region:"ä¸‹è‚¢", nerve:"å¤§è…¿ç¥çµŒï¼ˆL2â€“L4ï¼‰", origin:"å¤§è…¿éª¨ç²—ç·šå¤–å´å”‡ãƒ»å¤§è»¢å­", insertion:"è†è“‹éª¨â†’è†è“‹é­å¸¯â†’è„›éª¨ç²—é¢"},
  {name_ja:"å†…å´åºƒç­‹", name_lat:"Vastus medialis", region:"ä¸‹è‚¢", nerve:"å¤§è…¿ç¥çµŒï¼ˆL2â€“L4ï¼‰", origin:"å¤§è…¿éª¨ç²—ç·šå†…å´å”‡", insertion:"è†è“‹éª¨â†’è†è“‹é­å¸¯â†’è„›éª¨ç²—é¢"},
  {name_ja:"ä¸­é–“åºƒç­‹", name_lat:"Vastus intermedius", region:"ä¸‹è‚¢", nerve:"å¤§è…¿ç¥çµŒï¼ˆL2â€“L4ï¼‰", origin:"å¤§è…¿éª¨å‰é¢", insertion:"è†è“‹éª¨â†’è†è“‹é­å¸¯â†’è„›éª¨ç²—é¢"},
  {name_ja:"ç¸«å·¥ç­‹", name_lat:"Sartorius", region:"ä¸‹è‚¢", nerve:"å¤§è…¿ç¥çµŒï¼ˆL2â€“L3ï¼‰", origin:"ä¸Šå‰è…¸éª¨æ£˜", insertion:"éµè¶³ï¼ˆè„›éª¨å†…å´é¢è¿‘ä½éƒ¨ï¼‰"},
  {name_ja:"è–„ç­‹", name_lat:"Gracilis", region:"ä¸‹è‚¢", nerve:"é–‰é–ç¥çµŒï¼ˆL2â€“L3ï¼‰", origin:"æ¥éª¨ä¸‹æ", insertion:"éµè¶³ï¼ˆè„›éª¨å†…å´é¢è¿‘ä½éƒ¨ï¼‰"},
  {name_ja:"å¤§å†…è»¢ç­‹", name_lat:"Adductor magnus", region:"ä¸‹è‚¢", nerve:"é–‰é–ç¥çµŒï¼ˆå‰éƒ¨ï¼‰ï¼ˆL2â€“L4ï¼‰ï¼åéª¨ç¥çµŒè„›éª¨éƒ¨ï¼ˆå¾Œéƒ¨ï¼‰", origin:"æ¥éª¨ä¸‹æãƒ»åéª¨æãƒ»åéª¨çµç¯€", insertion:"ç²—ç·šå†…å´å”‡ã€œå†…è»¢ç­‹çµç¯€"},
  {name_ja:"é•·å†…è»¢ç­‹", name_lat:"Adductor longus", region:"ä¸‹è‚¢", nerve:"é–‰é–ç¥çµŒï¼ˆL2â€“L4ï¼‰", origin:"æ¥éª¨ä½“å‰é¢", insertion:"å¤§è…¿éª¨ç²—ç·šä¸­1/3"},
  {name_ja:"å¤§è…¿äºŒé ­ç­‹ï¼ˆé•·é ­ï¼‰", name_lat:"Biceps femoris long head", region:"ä¸‹è‚¢", nerve:"åéª¨ç¥çµŒè„›éª¨éƒ¨ï¼ˆL5â€“S2ï¼‰", origin:"åéª¨çµç¯€", insertion:"è…“éª¨é ­"},
  {name_ja:"å¤§è…¿äºŒé ­ç­‹ï¼ˆçŸ­é ­ï¼‰", name_lat:"Biceps femoris short head", region:"ä¸‹è‚¢", nerve:"åéª¨ç¥çµŒç·è…“éª¨éƒ¨ï¼ˆL5â€“S2ï¼‰", origin:"å¤§è…¿éª¨ç²—ç·šå¤–å´å”‡", insertion:"è…“éª¨é ­"},
  {name_ja:"åŠè…±æ§˜ç­‹", name_lat:"Semitendinosus", region:"ä¸‹è‚¢", nerve:"åéª¨ç¥çµŒè„›éª¨éƒ¨ï¼ˆL5â€“S2ï¼‰", origin:"åéª¨çµç¯€", insertion:"éµè¶³ï¼ˆè„›éª¨å†…å´é¢è¿‘ä½éƒ¨ï¼‰"},
  {name_ja:"åŠè†œæ§˜ç­‹", name_lat:"Semimembranosus", region:"ä¸‹è‚¢", nerve:"åéª¨ç¥çµŒè„›éª¨éƒ¨ï¼ˆL5â€“S2ï¼‰", origin:"åéª¨çµç¯€", insertion:"è„›éª¨å†…å´é¡†å¾Œæ–¹"},
  {name_ja:"å‰è„›éª¨ç­‹", name_lat:"Tibialis anterior", region:"ä¸‹è‚¢", nerve:"æ·±è…“éª¨ç¥çµŒï¼ˆL4â€“L5ï¼‰", origin:"è„›éª¨å¤–å´é¡†ãƒ»å¤–å´é¢è¿‘ä½éƒ¨ãƒ»éª¨é–“è†œ", insertion:"å†…å´æ¥”çŠ¶éª¨ãƒ»ç¬¬1ä¸­è¶³éª¨åº•å†…å´"},
  {name_ja:"é•·è¶¾ä¼¸ç­‹", name_lat:"Extensor digitorum longus", region:"ä¸‹è‚¢", nerve:"æ·±è…“éª¨ç¥çµŒï¼ˆL5â€“S1ï¼‰", origin:"è„›éª¨å¤–å´é¡†ãƒ»è…“éª¨å‰é¢ãƒ»éª¨é–“è†œ", insertion:"ç¬¬2â€“5è¶¾ä¸­ãƒ»æœ«ç¯€èƒŒå´"},
  {name_ja:"é•·è…“éª¨ç­‹", name_lat:"Fibularis (Peroneus) longus", region:"ä¸‹è‚¢", nerve:"æµ…è…“éª¨ç¥çµŒï¼ˆL5â€“S1ï¼‰", origin:"è…“éª¨é ­ãƒ»å¤–å´é¢ä¸Šéƒ¨", insertion:"ç¬¬1ä¸­è¶³éª¨åº•ãƒ»å†…å´æ¥”çŠ¶éª¨åº•ï¼ˆè¶³åº•çµŒç”±ï¼‰"},
  {name_ja:"çŸ­è…“éª¨ç­‹", name_lat:"Fibularis brevis", region:"ä¸‹è‚¢", nerve:"æµ…è…“éª¨ç¥çµŒï¼ˆL5â€“S1ï¼‰", origin:"è…“éª¨å¤–å´é¢ä¸‹éƒ¨", insertion:"ç¬¬5ä¸­è¶³éª¨ç²—é¢"},
  {name_ja:"è…“è…¹ç­‹", name_lat:"Gastrocnemius", region:"ä¸‹è‚¢", nerve:"è„›éª¨ç¥çµŒï¼ˆS1â€“S2ï¼‰", origin:"å¤§è…¿éª¨å†…ãƒ»å¤–å´é¡†ã®å¾Œé¢", insertion:"ã‚¢ã‚­ãƒ¬ã‚¹è…±â†’è¸µéª¨éš†èµ·"},
  {name_ja:"ãƒ’ãƒ©ãƒ¡ç­‹", name_lat:"Soleus", region:"ä¸‹è‚¢", nerve:"è„›éª¨ç¥çµŒï¼ˆS1â€“S2ï¼‰", origin:"è…“éª¨é ­ãƒ»ãƒ’ãƒ©ãƒ¡ç­‹ç·šãƒ»è„›éª¨", insertion:"ã‚¢ã‚­ãƒ¬ã‚¹è…±â†’è¸µéª¨éš†èµ·"},
  {name_ja:"å¾Œè„›éª¨ç­‹", name_lat:"Tibialis posterior", region:"ä¸‹è‚¢", nerve:"è„›éª¨ç¥çµŒï¼ˆL4â€“L5ï¼‰", origin:"è„›éª¨ãƒ»è…“éª¨å¾Œé¢ãƒ»éª¨é–“è†œ", insertion:"èˆŸçŠ¶éª¨ç²—é¢ãƒ»æ¥”çŠ¶éª¨ãƒ»ç«‹æ–¹éª¨ãƒ»ç¬¬2â€“4ä¸­è¶³éª¨åº•"},
  {name_ja:"é•·æ¯è¶¾å±ˆç­‹", name_lat:"Flexor hallucis longus", region:"ä¸‹è‚¢", nerve:"è„›éª¨ç¥çµŒï¼ˆS2â€“S3ï¼‰", origin:"è…“éª¨å¾Œé¢ä¸‹éƒ¨ãƒ»éª¨é–“è†œ", insertion:"æ¯è¶¾æœ«ç¯€éª¨åº•"},
  // â€”â€” ä½“å¹¹ãƒ»é ¸éƒ¨ â€”â€”
  {name_ja:"è…¹ç›´ç­‹", name_lat:"Rectus abdominis", region:"ä½“å¹¹", nerve:"è‚‹é–“ç¥çµŒï¼ˆT7â€“T12ï¼‰", origin:"æ¥éª¨ç¨œãƒ»æ¥éª¨çµåˆ", insertion:"å‰£çŠ¶çªèµ·ãƒ»ç¬¬5â€“7è‚‹è»Ÿéª¨"},
  {name_ja:"å¤–è…¹æ–œç­‹", name_lat:"External oblique", region:"ä½“å¹¹", nerve:"è‚‹é–“ç¥çµŒï¼ˆT7â€“T12ï¼‰", origin:"ç¬¬5â€“12è‚‹éª¨å¤–å´é¢", insertion:"ç™½ç·šãƒ»è…¸éª¨ç¨œãƒ»é¼¡å¾„é­å¸¯"},
  {name_ja:"å†…è…¹æ–œç­‹", name_lat:"Internal oblique", region:"ä½“å¹¹", nerve:"è‚‹é–“ç¥çµŒï¼ˆT7â€“T12ï¼‰ï¼‹è…¸éª¨ä¸‹è…¹ãƒ»è…¸éª¨é¼ å¾„ç¥çµŒï¼ˆL1ï¼‰", origin:"èƒ¸è…°ç­‹è†œãƒ»è…¸éª¨ç¨œãƒ»é¼¡å¾„é­å¸¯", insertion:"ç¬¬10â€“12è‚‹éª¨ãƒ»ç™½ç·šãƒ»è…±å¼“"},
  {name_ja:"è…¹æ¨ªç­‹", name_lat:"Transversus abdominis", region:"ä½“å¹¹", nerve:"è‚‹é–“ç¥çµŒï¼ˆT7â€“T12ï¼‰ï¼‹è…¸éª¨ä¸‹è…¹ãƒ»è…¸éª¨é¼ å¾„ç¥çµŒï¼ˆL1ï¼‰", origin:"ç¬¬7â€“12è‚‹è»Ÿéª¨å†…é¢ãƒ»èƒ¸è…°ç­‹è†œãƒ»è…¸éª¨ç¨œãƒ»é¼¡å¾„é­å¸¯", insertion:"ç™½ç·šãƒ»æ¥éª¨ç¨œ"},
  {name_ja:"èƒ¸é–ä¹³çªç­‹", name_lat:"Sternocleidomastoid", region:"é ¸éƒ¨", nerve:"å‰¯ç¥çµŒï¼ˆXIï¼‰ï¼‹C2â€“C3", origin:"èƒ¸éª¨æŸ„ãƒ»é–éª¨å†…å´ç«¯", insertion:"ä¹³æ§˜çªèµ·ãƒ»ä¸Šé …ç·šå¤–å´éƒ¨"}
];

// ====== é€²æ—ç®¡ç† ======
const LS_KEY = "muscle_quiz_items_v1";
const LS_STAT = "muscle_quiz_stats_v1";
const LS_FAV  = "muscle_quiz_favs_v1";
const LS_MODE = "muscle_quiz_prefs_v1";

function loadItems(){
  const saved = localStorage.getItem(LS_KEY);
  return saved ? JSON.parse(saved) : DEFAULT_ITEMS;
}
function saveItems(data){ localStorage.setItem(LS_KEY, JSON.stringify(data)); }
function loadStats(){
  const s = localStorage.getItem(LS_STAT);
  return s ? JSON.parse(s) : {right:0, wrong:0, streak:0, misses:[], last:0};
}
function saveStats(s){ localStorage.setItem(LS_STAT, JSON.stringify(s)); }
function loadFav(){ const f = localStorage.getItem(LS_FAV); return f? JSON.parse(f): {}; }
function saveFav(f){ localStorage.setItem(LS_FAV, JSON.stringify(f)); }
function loadPrefs(){ const p = localStorage.getItem(LS_MODE); return p? JSON.parse(p): {}; }
function savePrefs(p){ localStorage.setItem(LS_MODE, JSON.stringify(p)); }

// ====== å‡ºé¡Œã‚¨ãƒ³ã‚¸ãƒ³ ======
let ITEMS = loadItems();
let FAVS = loadFav();
let STATS = loadStats();
let PREFS = Object.assign({region:"all", mode:"mc", ask:"mixed", onlyMiss:false, onlyFav:false}, loadPrefs());

const $ = (id)=>document.getElementById(id);
const regionSel = $("region"); const modeSel = $("mode"); const askSel = $("ask");

regionSel.value = PREFS.region; modeSel.value = PREFS.mode; askSel.value = PREFS.ask;

const qmeta = $("qmeta"); const qtext = $("qtext"); const choices = $("choices");
const explain = $("explain"); const reveal = $("reveal");
const statRight = $("statRight"), statWrong=$("statWrong"), streak=$("streak"), favCount=$("favCount");
const typeWrap=$("typeWrap"), typeInput=$("typeInput");

let order = [...ITEMS.keys()];
let idx = 0;
let current = null;
let currentAsk = "mixed";

function filteredIndices(){
  const reg = regionSel.value;
  let base = ITEMS.map((_,i)=>i);
  if(reg!=="all") base = base.filter(i=>ITEMS[i].region===reg);
  if(PREFS.onlyFav) base = base.filter(i=>FAVS[i]);
  if(PREFS.onlyMiss && STATS.misses.length){
    base = base.filter(i=>STATS.misses.includes(i));
  }
  if(base.length===0) base = ITEMS.map((_,i)=>i);
  return base;
}

function shuffle(a){
  for(let i=a.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]]; }
  return a;
}

function pickQuestionType(){
  const ask = askSel.value;
  if(ask!=="mixed") return ask;
  const types = ["name_to_nerve","name_to_oi","nerve_to_name","oi_to_name"];
  return types[Math.floor(Math.random()*types.length)];
}

function makeMCOptions(correctIdx, field, count=4){
  const opts = new Set([correctIdx]);
  const pool = filteredIndices();
  shuffle(pool);
  for(const i of pool){
    if(opts.size>=count) break;
    if(i!==correctIdx){
      // avoid same value duplicates
      if(ITEMS[i][field] !== ITEMS[correctIdx][field]) opts.add(i);
    }
  }
  const arr = [...opts];
  shuffle(arr);
  return arr.map(i=>({i, text: ITEMS[i][field]}));
}

function render(){
  const pool = filteredIndices();
  if(!pool.includes(order[idx])) idx = 0;
  if(idx>=pool.length) idx=0;
  const i = pool[idx];
  current = i;
  currentAsk = pickQuestionType();

  const it = ITEMS[i];
  const metaTags = [`é ˜åŸŸï¼š${it.region}`, FAVS[i]?"â˜…ãŠæ°—ã«å…¥ã‚Š":"", `#${idx+1}/${pool.length}`].filter(Boolean);
  qmeta.textContent = metaTags.join(" Â· ");
  reveal.classList.add("hidden");
  $("reveal").open=false;

  const qa = {
    name_to_nerve: {q:`æ¬¡ã®ç­‹ã®<strong>ç¥çµŒæ”¯é…</strong>ã¯ï¼Ÿ<br><span class="pill tag">${it.name_ja} <span class="qmeta">(${it.name_lat})</span></span>`, correct: it.nerve, field:"nerve"},
    name_to_oi:    {q:`æ¬¡ã®ç­‹ã®<strong>èµ·å§‹ãƒ»åœæ­¢</strong>ã¯ï¼Ÿ<br><span class="pill tag">${it.name_ja} <span class="qmeta">(${it.name_lat})</span></span>`, correct:`èµ·å§‹ï¼š${it.origin}<br>åœæ­¢ï¼š${it.insertion}`, field:null},
    nerve_to_name: {q:`ã“ã®<strong>ç¥çµŒ</strong>ãŒæ”¯é…ã™ã‚‹ç­‹ã¯ï¼Ÿ<br><span class="pill tag">${it.nerve}</span>`, correct: it.name_ja, field:"name_ja"},
    oi_to_name:    {q:`ã“ã®<strong>èµ·å§‹ãƒ»åœæ­¢</strong>ã‚’æŒã¤ç­‹ã¯ï¼Ÿ<br><span class="pill tag">èµ·å§‹ï¼š${it.origin}ï¼åœæ­¢ï¼š${it.insertion}</span>`, correct: it.name_ja, field:"name_ja"}
  }[currentAsk];

  qtext.innerHTML = qa.q;
  explain.innerHTML = `
    <div class="stack">
      <span class="pill">ç­‹åï¼š<b>${it.name_ja}</b> <span class="qmeta">(${it.name_lat})</span></span>
      <span class="pill">é ˜åŸŸï¼š${it.region}</span>
    </div>
    <div style="margin-top:8px; line-height:1.6">
      <div><b>ç¥çµŒæ”¯é…ï¼š</b>${it.nerve}</div>
      <div><b>èµ·å§‹ï¼š</b>${it.origin}</div>
      <div><b>åœæ­¢ï¼š</b>${it.insertion}</div>
    </div>
  `;

  // Mode rendering
  choices.innerHTML = "";
  typeWrap.classList.add("hidden");
  if(modeSel.value==="mc"){
    // field to build distractors
    if(currentAsk==="name_to_oi"){
      // Special: options are blocks of O/I text
      const opts = makeMCOptions(i, "origin").map(o=>({i:o.i, text:`èµ·å§‹ï¼š${ITEMS[o.i].origin}<br>åœæ­¢ï¼š${ITEMS[o.i].insertion}`}));
      opts.forEach(opt=>{
        const btn = document.createElement("button");
        btn.className="choice";
        btn.innerHTML = opt.text;
        btn.onclick=()=>grade(opt.i===i, btn);
        choices.appendChild(btn);
      });
    }else if(currentAsk==="name_to_nerve"){
      const opts = makeMCOptions(i, "nerve");
      opts.forEach(opt=>{
        const btn = document.createElement("button");
        btn.className="choice";
        btn.innerHTML = opt.text;
        btn.onclick=()=>grade(opt.i===i, btn);
        choices.appendChild(btn);
      });
    }else{
      // answer is muscle name, distract by name_ja
      const opts = makeMCOptions(i, "name_ja");
      opts.forEach(opt=>{
        const btn = document.createElement("button");
        btn.className="choice";
        btn.textContent = ITEMS[opt.i].name_ja;
        btn.onclick=()=>grade(opt.i===i, btn);
        choices.appendChild(btn);
      });
    }
  }else if(modeSel.value==="type"){
    typeWrap.classList.remove("hidden");
    typeInput.value="";
    typeInput.placeholder = (currentAsk==="nerve_to_name"||currentAsk==="oi_to_name") ? "ç­‹åã‚’å…¥åŠ›ï¼ˆä¾‹ï¼šä¸‰è§’ç­‹ï¼‰" : (currentAsk==="name_to_nerve" ? "ç¥çµŒåã‚’å…¥åŠ›ï¼ˆä¾‹ï¼šè…‹çª©ç¥çµŒï¼‰" : "èµ·å§‹/åœæ­¢ã‚’æ›¸ã„ã¦ã‚‚OK");
  }else{
    // flashcard
    const btn = document.createElement("button");
    btn.className="choice";
    btn.innerHTML = "<b>ã‚¿ãƒƒãƒ—ã§ç­”ãˆã‚’è¡¨ç¤º</b>";
    btn.onclick=()=>{ reveal.classList.remove("hidden"); $("reveal").open=true; };
    choices.appendChild(btn);
  }

  updateStatsUI();
}

function normalize(str){
  return (str||"").toString().toLowerCase()
    .replace(/\s+/g,"").replace(/[ï¼ˆï¼‰()ãƒ»\/]/g,"");
}

function grade(isCorrect, btn){
  reveal.classList.remove("hidden");
  $("reveal").open=true;

  if(isCorrect){
    btn && btn.classList.add("correct");
    STATS.right++; STATS.streak++;
    // remove from misses if present
    STATS.misses = STATS.misses.filter(m=>m!==current);
  }else{
    btn && btn.classList.add("wrong");
    STATS.wrong++; STATS.streak=0;
    if(!STATS.misses.includes(current)) STATS.misses.push(current);
  }
  saveStats(STATS);
  updateStatsUI();
}

function gradeTyping(){
  const it = ITEMS[current];
  const ans = typeInput.value.trim();
  if(!ans){ typeInput.focus(); return; }
  let ok=false;
  if(currentAsk==="name_to_nerve"){
    ok = normalize(ans).includes(normalize(it.nerve));
  }else if(currentAsk==="name_to_oi"){
    ok = normalize(ans).includes(normalize(it.origin)) || normalize(ans).includes(normalize(it.insertion));
  }else{
    ok = normalize(ans)===normalize(it.name_ja) || normalize(ans)===normalize(it.name_lat);
  }
  grade(ok, null);
}

function updateStatsUI(){
  statRight.textContent = STATS.right;
  statWrong.textContent = STATS.wrong;
  streak.textContent = STATS.streak;
  favCount.textContent = Object.values(FAVS).filter(Boolean).length;
}

function toJSONText(){
  return JSON.stringify(ITEMS, null, 2);
}

function fromJSONText(txt){
  const arr = JSON.parse(txt);
  if(!Array.isArray(arr)) throw new Error("é…åˆ—ã§ã¯ã‚ã‚Šã¾ã›ã‚“");
  // è»½ã„æ¤œè¨¼
  for(const o of arr){
    ["name_ja","name_lat","region","nerve","origin","insertion"].forEach(k=>{
      if(typeof o[k] !== "string") throw new Error("é …ç›®ã®å‹ãŒä¸æ­£ã§ã™: "+k);
    });
  }
  return arr;
}

// ====== ã‚¤ãƒ™ãƒ³ãƒˆ ======
$("next").onclick=()=>{ idx=(idx+1)%filteredIndices().length; render(); }
$("prev").onclick=()=>{ idx=(idx-1+filteredIndices().length)%filteredIndices().length; render(); }
$("again").onclick=()=>render();
$("typeCheck").onclick=gradeTyping;
$("typeShow").onclick=()=>{ reveal.classList.remove("hidden"); $("reveal").open=true; };

$("shuffle").onclick=()=>{ order = shuffle(filteredIndices()); idx=0; render(); }
$("onlyMiss").onclick=()=>{ PREFS.onlyMiss = !PREFS.onlyMiss; savePrefs(PREFS); $("onlyMiss").classList.toggle("fav", PREFS.onlyMiss); idx=0; render(); };
$("toggleFav").onclick=(e)=>{
  if(!current) return;
  FAVS[current] = !FAVS[current];
  saveFav(FAVS);
  // é•·æŠ¼ã—ã§ãŠæ°—ã«å…¥ã‚Šã®ã¿ãƒˆã‚°ãƒ«
  e.currentTarget.onmousedown = (ev)=>{
    const t = setTimeout(()=>{ PREFS.onlyFav=!PREFS.onlyFav; savePrefs(PREFS); idx=0; render(); }, 500);
    e.currentTarget.onmouseup = ()=>clearTimeout(t);
    e.currentTarget.onmouseleave = ()=>clearTimeout(t);
  };
  render();
};

regionSel.onchange=()=>{ PREFS.region = regionSel.value; savePrefs(PREFS); idx=0; render(); };
modeSel.onchange=()=>{ PREFS.mode = modeSel.value; savePrefs(PREFS); render(); };
askSel.onchange=()=>{ PREFS.ask = askSel.value; savePrefs(PREFS); render(); };

$("reset").onclick=()=>{
  if(confirm("æˆç¸¾ã¨é–“é•ã„ãƒªã‚¹ãƒˆã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã‹ï¼Ÿ")){
    STATS = {right:0, wrong:0, streak:0, misses:[], last:0}; saveStats(STATS); updateStatsUI();
  }
};

$("jsonArea").value = toJSONText();
$("applyJson").onclick=()=>{
  try{
    const arr = fromJSONText($("jsonArea").value);
    ITEMS = arr; saveItems(ITEMS);
    order = [...ITEMS.keys()]; idx=0; render();
    alert("æ›´æ–°ã—ã¾ã—ãŸ");
  }catch(e){ alert("ã‚¨ãƒ©ãƒ¼: "+e.message); }
};
$("downloadJson").onclick=()=>{
  const blob = new Blob([toJSONText()], {type:"application/json"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url; a.download = "muscle-quiz-data.json"; a.click();
  URL.revokeObjectURL(url);
};

// åˆæœŸåŒ–
order = shuffle(filteredIndices());
render();
</script>
</body>
</html>